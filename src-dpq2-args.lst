       |/// Dealing with query arguments
       |module dpq2.args;
       |
       |@safe:
       |
       |public import dpq2.conv.from_d_types;
       |public import dpq2.conv.from_bson;
       |
       |import dpq2.value;
       |import dpq2.oids: Oid;
       |import std.conv: to;
       |import std.string: toStringz;
       |
       |/// Query parameters
       |struct QueryParams
       |{
       |    string sqlCommand; /// SQL command
       |    ValueFormat resultFormat = ValueFormat.BINARY; /// Result value format
       |    private Value[] _args; // SQL command arguments
       |
       |    /// SQL command arguments
       |    @property void args(Value[] vargs)
       |    {
0000000|        _args = vargs;
       |    }
       |
       |    /// ditto
       |    @property ref inout (Value[]) args() inout pure
       |    {
     32|        return _args;
       |    }
       |
       |    /// Fills out arguments from array
       |    ///
       |    /// Useful for simple text-only query params
       |    /// Postgres infers a data type for the parameter in the same way it would do for an untyped literal string.
       |    @property void argsFromArray(in string[] arr)
       |    {
0000000|        _args.length = arr.length;
       |
0000000|        foreach(i, ref a; _args)
0000000|            a = toValue(arr[i], ValueFormat.TEXT);
       |    }
       |
       |    /// Fills out arguments from variadic arguments
       |    void argsVariadic(Targs ...)(Targs t_args)
       |    {
      1|        _args.length = t_args.length;
       |
       |        static foreach(i, T; Targs)
       |        {
      3|            _args[i] = toValue!T(t_args[i]);
       |        }
       |    }
       |
       |    /// Access to prepared statement name
       |    ///
       |    /// Use it to prepare queries
       |    // FIXME: it is need to check in debug mode what sqlCommand is used in "SQL command" or "prepared statement" mode
0000000|    @property string preparedStatementName() const { return sqlCommand; }
       |    /// ditto
0000000|    @property void preparedStatementName(string s){ sqlCommand = s; }
       |}
       |
       |unittest
       |{
      1|    QueryParams qp;
      1|    qp.argsVariadic(123, "asd", true);
       |
      4|    assert(qp.args[0] == 123.toValue);
      4|    assert(qp.args[1] == "asd".toValue);
      4|    assert(qp.args[2] == true.toValue);
       |}
       |
       |/// Used as parameters by PQexecParams-like functions
       |package struct InternalQueryParams
       |{
       |    private
       |    {
       |        const(string)* sqlCommand;
       |        Oid[] oids;
       |        int[] formats;
       |        int[] lengths;
       |        const(ubyte)*[] values;
       |    }
       |
       |    ValueFormat resultFormat;
       |
0000000|    this(in QueryParams* qp) pure
       |    {
0000000|        sqlCommand = &qp.sqlCommand;
0000000|        resultFormat = qp.resultFormat;
       |
0000000|        oids = new Oid[qp.args.length];
0000000|        formats = new int[qp.args.length];
0000000|        lengths = new int[qp.args.length];
0000000|        values = new const(ubyte)* [qp.args.length];
       |
0000000|        for(int i = 0; i < qp.args.length; ++i)
       |        {
0000000|            oids[i] = qp.args[i].oidType;
0000000|            formats[i] = qp.args[i].format;
       |
0000000|            if(!qp.args[i].isNull)
       |            {
0000000|                lengths[i] = qp.args[i].data.length.to!int;
       |
0000000|                immutable ubyte[] zeroLengthArg = [123]; // fake value, isn't used as argument
       |
0000000|                if(qp.args[i].data.length == 0)
0000000|                    values[i] = &zeroLengthArg[0];
       |                else
0000000|                    values[i] = &qp.args[i].data[0];
       |            }
       |        }
       |    }
       |
       |    /// Values used by PQexecParams-like functions
       |    const(char)* command() pure const
       |    {
0000000|        return cast(const(char)*) (*sqlCommand).toStringz;
       |    }
       |
       |    /// ditto
       |    const(char)* stmtName() pure const
       |    {
0000000|        return command();
       |    }
       |
       |    /// ditto
       |    int nParams() pure const
       |    {
0000000|        return values.length.to!int;
       |    }
       |
       |    /// ditto
       |    const(Oid)* paramTypes() pure
       |    {
0000000|        if(oids.length == 0)
0000000|            return null;
       |        else
0000000|            return &oids[0];
       |    }
       |
       |    /// ditto
       |    const(ubyte*)* paramValues() pure
       |    {
0000000|        if(values.length == 0)
0000000|            return null;
       |        else
0000000|            return &values[0];
       |    }
       |
       |    /// ditto
       |    const(int)* paramLengths() pure
       |    {
0000000|        if(lengths.length == 0)
0000000|            return null;
       |        else
0000000|            return &lengths[0];
       |    }
       |
       |    /// ditto
       |    const(int)* paramFormats() pure
       |    {
0000000|        if(formats.length == 0)
0000000|            return null;
       |        else
0000000|            return &formats[0];
       |    }
       |}
src/dpq2/args.d is 17% covered
